<script>
const screens=document.querySelectorAll('.screen');
function show(id){
  screens.forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
setTimeout(()=>show('name'),2500);

/* NAME */
const f=document.getElementById('fname');
const b=document.getElementById('nameBtn');
f.oninput=()=>b.disabled=f.value.length<2;
b.onclick=()=>{
  document.getElementById('hello').innerHTML=
   `Dear <span style="color:#00c6ff">${f.value}</span><br>
    Welcome To Wasif MD Session Generator`;
  show('home');
}

/* PHONE */
function openPhone(type){
  const c=document.getElementById('code');
  c.innerHTML = type==='pk'
   ? '<option>+92</option>'
   : '<option>+92</option><option>+1</option><option>+44</option>';
  show('phone');
}
number.oninput=()=>pairBtn.disabled=number.value.length<7;

/* REAL PAIR */
async function realPair(){
  const full = code.value.replace('+','') + number.value;
  const res = await fetch('/pair',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({number:full})
  });
  const data = await res.json();
  if(data.code){
    pairCode.innerText=data.code;
    pairBox.style.display='block';
  }else{
    alert('Pairing Failed');
  }
}

/* COPY PAIR CODE + MOVE TO SESSION SCREEN */
function copyCode(){
  navigator.clipboard.writeText(pairCode.innerText);
  showSessionScreen();
  startSessionCheck();
}

/* ========== SESSION SCREEN (AUTO CREATED) ========== */
const sessionScreen = document.createElement('div');
sessionScreen.className = 'screen';
sessionScreen.id = 'session';
sessionScreen.innerHTML = `
  <div class="card">
    <h2>SESSION ID</h2>
    <div class="codebox" id="sessionText">Coding in progress...</div>
    <button class="btn2" onclick="copySession()" style="display:none" id="copySessionBtn">
      Copy Session
    </button>
  </div>
`;
document.body.appendChild(sessionScreen);

function showSessionScreen(){
  screens.forEach(s=>s.classList.remove('active'));
  sessionScreen.classList.add('active');
}

/* POLL SESSION FROM BACKEND */
async function startSessionCheck(){
  const timer = setInterval(async ()=>{
    const res = await fetch('/session');
    const data = await res.json();
    if(data.session){
      document.getElementById('sessionText').innerText = data.session;
      document.getElementById('copySessionBtn').style.display='block';
      clearInterval(timer);
    }
  }, 3000);
}

function copySession(){
  navigator.clipboard.writeText(
    document.getElementById('sessionText').innerText
  );
}

function wa(n){window.open('https://wa.me/'+n)}
</script>
