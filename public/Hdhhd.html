<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wasif MD Session Generator</title>

<style>
*{box-sizing:border-box;font-family:Poppins,Arial}
body{margin:0;background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;overflow:hidden;}
.screen{display:flex;height:100vh;width:100%;align-items:center;justify-content:center;flex-direction:column;animation:fade .4s ease;}
@keyframes fade{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
.card{width:92%;max-width:420px;background:#111c;padding:22px;border-radius:18px;box-shadow:0 0 30px #000;text-align:center;}
h1,h2{margin:10px 0}
button{width:100%;padding:14px;border:none;border-radius:16px;color:#fff;font-size:14px;margin-top:10px;cursor:pointer;}
button:disabled{opacity:.4}
.small{font-size:12px;opacity:.8}
.row{display:flex;gap:8px}
.code{flex:0 0 30%}
.num{flex:1}
.in1{background:linear-gradient(135deg,#ffecd2,#fcb69f)}
.in2{background:linear-gradient(135deg,#d4fc79,#96e6a1)}
.in3{background:linear-gradient(135deg,#a1c4fd,#c2e9fb)}
.in4{background:linear-gradient(135deg,#fbc2eb,#a6c1ee)}
.btn1{background:linear-gradient(135deg,#00c6ff,#0072ff)}
.btn2{background:linear-gradient(135deg,#f7971e,#ffd200)}
.btn3{background:linear-gradient(135deg,#fc5c7d,#6a82fb)}
.btn4{background:linear-gradient(135deg,#43cea2,#185a9d)}
.btn5{background:linear-gradient(135deg,#ff512f,#dd2476)}
.btn6{background:linear-gradient(135deg,#8360c3,#2ebf91)}
.btnBack{background:linear-gradient(135deg,#555,#222)}
.status-bar{margin-top:10px;font-size:13px;opacity:.8;}
.panel{margin-top:12px;background:#0008;padding:12px;border-radius:12px;text-align:center;display:none;}
.panel img{max-width:100%;border-radius:12px;}
.flex-row{display:flex;gap:10px;justify-content:center;margin-top:10px;}
.flex-row button{width:auto;padding:10px 20px;font-size:13px;}
</style>

</head>

<body>

<div class="screen">
  <div class="card">
    <h2 id="hello">Welcome!</h2>

    <div id="link-buttons">
      <button class="btn2" onclick="showPairPanel()">Link With Phone Number</button>
      <button class="btn3" onclick="showQRPanel()">Link With QR</button>
    </div>

    <div class="status-bar">
      Connection: <span id="conn-status">Checking...</span> | Database: <span id="db-status">Checking...</span>
    </div>

    <div class="flex-row">
      <button class="btnBack" onclick="disconnect()">Disconnect</button>
      <button class="btn4" onclick="checkStatus()">Refresh Status</button>
    </div>

    <!-- Pairing Panel -->
    <div class="panel" id="pair-panel">
      <h3>Enter Your Number</h3>
      <div class="row">
        <select class="in3 code" id="code"></select>
        <input class="in4 num" id="number" placeholder="Phone Number">
      </div>
      <button class="btn1" id="pairBtn" disabled onclick="realPair()">Request Pairing Code</button>
      <div id="pairBox" style="margin-top:10px;">
        <div class="panel" id="pairCode"></div>
        <button class="btn2" onclick="copyCode()">Copy Pairing Code</button>
      </div>
      <div id="sessionBox" style="margin-top:10px;">
        <div class="panel" id="sessionText">Waiting for session...</div>
        <button class="btn2" onclick="copySession()">Copy Session</button>
      </div>
      <button class="btnBack" onclick="closePairPanel()">Close</button>
    </div>

    <!-- QR Panel -->
    <div class="panel" id="qr-panel">
      <h3>Scan QR Code</h3>
      <div id="qr-container">
        <img id="qr-image" src="" alt="QR Code">
      </div>
      <button class="btnBack" onclick="closeQRPanel()">Close</button>
    </div>

  </div>
</div>

<script>
const fname=prompt("Enter your name")||"User";
document.getElementById('hello').innerHTML=`Hello <span style="color:#00c6ff">${fname}</span>`;

// Link panel functions
const code=document.getElementById('code');
const number=document.getElementById('number');
const pairBtn=document.getElementById('pairBtn');
const pairCode=document.getElementById('pairCode');
const sessionText=document.getElementById('sessionText');
const pairPanel=document.getElementById('pair-panel');
const qrPanel=document.getElementById('qr-panel');
const linkButtons=document.getElementById('link-buttons');

function showPairPanel(){
  pairPanel.style.display='block';
  qrPanel.style.display='none';
  code.innerHTML='<option>+92</option><option>+1</option><option>+44</option>';
}
function closePairPanel(){pairPanel.style.display='none';}
number.oninput=()=>pairBtn.disabled=number.value.length<7;

async function realPair(){
  const full=code.value.replace('+','')+number.value;
  try{
    const r=await fetch('/api/pair',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ phone: full })
    });
    const d=await r.json();
    if(d.code){
      pairCode.innerText=d.code;
      pairCode.style.display='block';
      pollSession();
    } else alert(d.error||'Pairing Failed');
  } catch(e){alert('Network error');}
}
function copyCode(){navigator.clipboard.writeText(pairCode.innerText);}
function copySession(){navigator.clipboard.writeText(sessionText.innerText);}
async function pollSession(){
  const i=setInterval(async()=>{
    const r=await fetch('/api/status');
    const d=await r.json();
    if(d.session){
      sessionText.innerText=d.session;
      sessionText.style.display='block';
      if(d.linked) linkButtons.style.display='none';
      clearInterval(i);
    }
  },2000);
}

// QR
function showQRPanel(){
  qrPanel.style.display='block';
  pairPanel.style.display='none';
  fetch('/api/qr',{method:'POST'}).then(async()=>{
    const r=await fetch('/api/status');
    const d=await r.json();
    if(d.qr) document.getElementById('qr-image').src=d.qr;
  }).catch(()=>alert('Failed to fetch QR'));
}

// Disconnect
async function disconnect(){
  if(!confirm('Are you sure?')) return;
  try{
    await fetch('/api/disconnect',{method:'POST'});
    location.reload();
  }catch(e){alert('Failed to disconnect');}
}

// Status polling
async function checkStatus(){
  try{
    const r=await fetch('/api/status');
    const d=await r.json();
    document.getElementById('conn-status').innerText=d.connected?'Connected':'Waiting...';
    document.getElementById('db-status').innerText=d.database?'Connected':'Disabled';
    if(d.linked) linkButtons.style.display='none';
  }catch(e){}
}
setInterval(checkStatus,2000);
</script>

</body>
</html>
